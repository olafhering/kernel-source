From: Jiri Slaby <jslaby@suse.cz>
Subject: x86/speculation: IBRS, forbid shooting in foot
Patch-mainline: Never, SUSE specific
References: bsc#1068032 CVE-2017-5753 bnc#1119065

When a user tries to force IBRS on a system without IBRS support, the
system oopses. So check if the system supports IBRS first, before
enabling the support.

Signed-off-by: Jiri Slaby <jslaby@suse.cz>
---
 arch/x86/kernel/cpu/bugs.c |   13 ++++++++-----
 1 file changed, 8 insertions(+), 5 deletions(-)

--- a/arch/x86/kernel/cpu/bugs.c
+++ b/arch/x86/kernel/cpu/bugs.c
@@ -956,6 +956,14 @@ static void __init spectre_v2_select_mit
 	case SPECTRE_V2_CMD_NONE:
 		return;
 
+	case SPECTRE_V2_CMD_IBRS:
+		if (boot_cpu_has(X86_FEATURE_IBRS)) {
+			mode = SPECTRE_V2_IBRS;
+			setup_force_cpu_cap(X86_FEATURE_USE_IBRS);
+			break;
+		}
+
+		/* fall through */
 	case SPECTRE_V2_CMD_FORCE:
 	case SPECTRE_V2_CMD_AUTO:
 		if (boot_cpu_has(X86_FEATURE_IBRS_ENHANCED)) {
@@ -966,11 +974,6 @@ static void __init spectre_v2_select_mit
 		mode = spectre_v2_select_retpoline();
 		break;
 
-	case SPECTRE_V2_CMD_IBRS:
-		mode = SPECTRE_V2_IBRS;
-		setup_force_cpu_cap(X86_FEATURE_USE_IBRS);
-		break;
-
 	case SPECTRE_V2_CMD_RETPOLINE_LFENCE:
 		mode = SPECTRE_V2_LFENCE;
 		break;
